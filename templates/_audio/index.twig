{% extends "_core/LayoutMaster" %}

{# Static caching #}
{% set shouldCache = true %}

{# Variables #}
{% set speaker = speaker|default(null) %}
{% set activeSpeaker = null %}
{% set activeSeries = null %}
{% set series = series|default(null) %}
{% set backLink = false %}
{% set backLinkText = 'back to all messages' %}

{# Meta Title #}
{% set metaTitle = 'Messages' %}

{# Hero heading #}
{% set heroHeading = 'Messages from St. Mark' %}

{# Get the section #}
{% set section = section|default(null) %}

{# Get the page number #}
{% set pageNum = pageNum|default(null) %}

{# If the page number is 1, it is not valid, there should be no /page/1 #}
{# Or if there's not section #}
{% if pageNum == 1 or not section %}
    {% exit 404 %}
{% endif %}

{# Now if there's no page number, it should be 1 #}
{% set pageNum = pageNum|default(1)|cast('int') %}

{# Get the entries #}
{% set entriesQuery = craft.entries.section('messages') %}

{# Check if we are getting entries by a specific speaker #}
{% if speaker %}
    {% set speakerQuery = craft.users.slugField(speaker).one() %}
    {% if not speakerQuery %}{% exit 404 %}{% endif %}
    {% set entriesQuery = entriesQuery.relatedTo({
        targetElement: speakerQuery,
        field: 'speaker'
    }) %}

    {% if speakerQuery.titleOrHonorific %}
        {% set speakerName = speakerQuery.titleOrHonorific ~ ' ' ~ speakerQuery.fullName %}
    {% else %}
        {% set speakerName = speakerQuery.fullName %}
    {% endif %}

    {# Meta Title #}
    {% set metaTitle = 'Messages by ' ~ speakerName %}

    {# Hero heading #}
    {% set heroHeading = metaTitle %}

    {% set activeSpeaker = speakerQuery.slugField %}

    {% set backLink = '/media/messages' %}
{% endif %}

{# Check if we are getting entries in a series #}
{% if series %}
    {% set seriesQuery = craft.categories.group('messageSeries').slug(series).one() %}
    {% if not seriesQuery %}{% exit 404 %}{% endif %}
    {% set entriesQuery = entriesQuery.relatedTo({
        targetElement: seriesQuery,
        field: 'messageSeries'
    }) %}

    {# Meta Title #}
    {% set metaTitle = 'Messages series: ' ~ seriesQuery.title %}

    {# Hero heading #}
    {% set heroHeading = metaTitle %}

    {% set activeSeries = seriesQuery.slug %}

    {% set backLink = '/media/messages' %}
{% endif %}

{# Get the entries count #}
{% set entriesTotal = entriesQuery.count()|cast('int') %}

{# Set the limit #}
{% set limit = 10 %}

{# Set the max number of pages #}
{% set maxPages = ceil(entriesTotal / limit)|cast('int') %}

{# If we have exceeded the max number of pages we should 404 #}
{% if pageNum > maxPages %}
    {% exit 404 %}
{% endif %}

{# Get the offset #}
{% set offset = (limit * pageNum) - limit %}

{# Get the entries #}
{% set entries = entriesQuery.limit(limit).offset(offset).all() %}

{# Primary content #}
{% block content %}
    {% include '_partials/MessageList' with {
        entries: entries,
        pageNum: pageNum,
        limit: limit,
        entriesTotal: entriesTotal,
        backLink: backLink,
        backLinkText: backLinkText,
        activeSpeaker: activeSpeaker,
        activeSeries: activeSeries
    } only %}
{% endblock %}
